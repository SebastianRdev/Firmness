@model IEnumerable<Firmness.WebAdmin.Models.Customers.CustomerViewModel>

@{
ViewData["Title"] = "Customer Management";
var searchTerm = ViewData["SearchTerm"] as string;
var customersList = Model.ToList();

// Pagination
int currentPage = ViewData["CurrentPage"] as int? ?? 1;
int pageSize = 10;
int totalCustomers = customersList.Count;
int totalPages = (int)Math.Ceiling(totalCustomers / (double)pageSize);

var pagedCustomers = customersList
.Skip((currentPage - 1) * pageSize)
.Take(pageSize)
.ToList();
}

@Html.AntiForgeryToken()

<main class="flex-1 flex flex-col h-screen overflow-y-auto">
    <div class="p-6 md:p-8 space-y-6">

        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex min-w-72 flex-col gap-2">
                <h1 class="text-gray-900 dark:text-white text-3xl md:text-4xl font-black leading-tight tracking-tight">Customer Management</h1>
                <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">Manage your inventory of construction supplies and vehicle rentals.</p>
            </div>

            <!-- Import Excel Button -->
            <button class="flex items-center justify-center gap-2 min-w-[84px] cursor-pointer rounded-lg h-11 px-5 bg-green-600 text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700" id="importExcelBtn">
                <span class="material-symbols-outlined">cloud_upload</span>
                <span class="truncate">Importar Excel</span>
            </button>

            <a asp-controller="Customers" asp-action="Create" class="flex items-center justify-center gap-2 min-w-[84px] cursor-pointer rounded-lg h-11 px-5 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
                <span class="material-symbols-outlined">add_circle</span>
                <span class="truncate">Create New Customer</span>
            </a>
        </div>

        <!-- Notifications -->
        <partial name="_Notifications" />

        <!-- Search and Filter Bar -->
        <form asp-action="Search" method="get" class="flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
                <label class="flex flex-col min-w-40 h-12 w-full">
                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full bg-white dark:bg-background-dark border border-gray-300 dark:border-gray-700 focus-within:ring-2 focus-within:ring-primary">
                        <div class="text-gray-400 dark:text-gray-500 flex items-center justify-center pl-4">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input name="term"
                               value="@searchTerm"
                               class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-800 dark:text-gray-200 focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-gray-400 dark:placeholder:text-gray-500 px-4 pl-2 text-base font-normal leading-normal"
                               placeholder="Search by name or code..."/>
                    </div>
                </label>
            </div>

            <div class="flex gap-2">
                <button type="submit" class="h-12 px-6 rounded-lg bg-gray-800 dark:bg-gray-700 text-white hover:bg-gray-900 dark:hover:bg-gray-600 font-medium">
                    Search
                </button>
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <a asp-action="Index" class="h-12 px-6 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 font-medium flex items-center">
                        Clear
                    </a>
                }
            </div>
        </form>

        @if (!string.IsNullOrEmpty(searchTerm))
        {
            <div class="text-gray-600 dark:text-gray-400">
                Showing results for: <strong class="text-gray-800 dark:text-gray-200">"@searchTerm"</strong>
            </div>
        }
        
        <!-- Confirmation Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white dark:bg-background-dark rounded-xl shadow-lg w-full max-w-md">
                <div class="p-6">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50">
                            <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-3xl">warning</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Delete Customer</h3>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Are you sure you want to delete '<span id="customerName"></span>'? This action cannot be undone.</p>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 rounded-b-xl flex justify-end gap-3">
                    <button class="px-4 py-2 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600" data-bs-dismiss="modal" id="cancelDeleteBtn">Cancel</button>
                    <button class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h3 class="font-semibold text-gray-700 dark:text-gray-300">Headers leídos:</h3>
            <pre id="headersOutput" class="p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm text-gray-800 dark:text-gray-200 overflow-x-auto"></pre>
        </div>

        <!-- Table Container -->
        <div class="bg-white dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden">
            @if (pagedCustomers.Any())
            {
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr class="text-left">
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300">UserName</th>
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300">FullName</th>
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300">Role</th>
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300">Email</th>
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300">Address</th>
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300">PhoneNumber</th>
                            <th class="px-6 py-4 font-medium text-gray-600 dark:text-gray-300 text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
                        @foreach (var customer in pagedCustomers)
                        {
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium">
                                    @customer.UserName
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium">
                                    @customer.FullName
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium">
                                    @customer.Roles.Select(r => r.Text).FirstOrDefault()
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium">
                                    @customer.Email
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium">
                                    @customer.Address
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium">
                                    @customer.PhoneNumber
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <div class="flex justify-center items-center gap-2">
                                        <a asp-action="Details" asp-route-id="@customer.Id"
                                           class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                                           title="View Details">
                                            <span class="material-symbols-outlined text-xl">visibility</span>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@customer.Id"
                                           class="p-2 rounded-full hover:bg-yellow-100 dark:hover:bg-yellow-900/50 text-yellow-500 hover:text-yellow-600"
                                           title="Edit">
                                            <span class="material-symbols-outlined text-xl">edit</span>
                                        </a>
                                        <a asp-action="Delete" asp-route-id="@customer.Id"
                                           class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 hover:text-red-600"
                                           title="Delete">
                                            <span class="material-symbols-outlined text-xl">delete</span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</main>


<!-- Modal for Import Excel -->
<div id="importExcelModal" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Importar Clientes desde Excel</h2>
                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" id="closeImportModal">
                    <span class="material-symbols-outlined text-lg">close</span>
                </button>
            </div>
            <div class="mt-6">
                <form id="importExcelForm" method="post" enctype="multipart/form-data" asp-action="ImportExcel">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="entityType" value="customer" />
                    
                    <label class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed rounded-lg cursor-pointer border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" for="file-upload">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                            <span class="material-symbols-outlined text-4xl text-gray-400">cloud_upload</span>
                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Excel files (.xlsx, .xls)</p>
                        </div>
                        <input accept=".xlsx, .xls" type="file" name="file" id="file-upload"/>
                    </label>
                </form>
            </div>
        </div>
        <div class="flex justify-end gap-3 px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 rounded-b-xl">
            <button class="h-10 px-4 rounded-lg bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 text-sm font-bold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" id="cancelImportBtn">Cancelar</button>
            <button class="flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-primary text-white text-sm font-bold hover:bg-primary/90 transition-colors" id="confirmImportBtn">
                <span class="material-symbols-outlined text-lg">upload</span>
                <span>Importar</span>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelModal = document.getElementById('importExcelModal');
        const closeImportModal = document.getElementById('closeImportModal');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const headersOutput = document.getElementById('headersOutput');

        // Abrir modal
        importExcelBtn.addEventListener('click', () => importExcelModal.classList.remove('hidden'));

        // Cerrar modal
        closeImportModal.addEventListener('click', () => importExcelModal.classList.add('hidden'));
        cancelImportBtn.addEventListener('click', () => importExcelModal.classList.add('hidden'));

        // Botón de confirmar subida
        document.getElementById('confirmImportBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('file-upload');

            if (!fileInput.files.length) {
                alert('Por favor selecciona un archivo.');
                headersOutput.textContent = "No se seleccionó ningún archivo.";
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            // ✅ AGREGAR entityType (esto faltaba)
            formData.append('entityType', 'Customer'); // ⚠️ Debe coincidir con ColumnTemplates

            // Token antiforgery
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenInput) {
                formData.append('__RequestVerificationToken', tokenInput.value);
            }

            // Mostrar estado de carga
            headersOutput.textContent = "Subiendo archivo...";

            try {
                const response = await fetch('/Customers/ImportExcel', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const text = await response.text();
                    alert('Error al subir archivo: ' + text);
                    headersOutput.textContent = 'Error al leer headers: ' + text;
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    if (data.headers && data.headers.length > 0) {
                        headersOutput.textContent = data.headers.join(", ");
                        alert('Archivo subido correctamente. Headers leídos: ' + data.headers.join(', '));
                    } else {
                        headersOutput.textContent = "No se encontraron headers en el archivo.";
                        alert('Archivo subido pero no se pudieron leer los headers.');
                    }
                } else {
                    headersOutput.textContent = 'Error: ' + data.message;
                    alert('Error: ' + data.message);
                }

                importExcelModal.classList.add('hidden');
            } catch(err) {
                console.error(err);
                alert('Error al subir archivo.');
                headersOutput.textContent = "Error subiendo o leyendo el archivo: " + err.message;
            }
        });
    });

    // Modal de confirmación de eliminación
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('deleteModal');
        const customerNameSpan = document.getElementById('customerName');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        let customerIdToDelete = null;

        // Manejar clic en botones de eliminar
        document.querySelectorAll('a[title="Delete"]').forEach(function(deleteLink) {
            deleteLink.addEventListener('click', function(e) {
                e.preventDefault();

                const url = this.href;

                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            customerIdToDelete = data.customer.id;
                            customerNameSpan.textContent = data.customer.userName;
                            modal.classList.remove('hidden');
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while loading customer data.');
                    });
            });
        });

        // Cerrar modal al cancelar
        cancelDeleteBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            customerIdToDelete = null;
        });

        // Cerrar modal al hacer clic fuera de él
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                customerIdToDelete = null;
            }
        });

        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                modal.classList.add('hidden');
                customerIdToDelete = null;
            }
        });

        // Confirmar eliminación
        confirmDeleteBtn.addEventListener('click', function() {
            if (!customerIdToDelete) return;

            confirmDeleteBtn.disabled = true;
            const originalText = confirmDeleteBtn.textContent;
            confirmDeleteBtn.textContent = 'Deleting...';

            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            const formData = new FormData();
            if (token) {
                formData.append('__RequestVerificationToken', token.value);
            }

            fetch(`/Customers/DeleteConfirmed/${customerIdToDelete}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.classList.add('hidden');
                        alert('Customer deleted successfully!');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                        confirmDeleteBtn.disabled = false;
                        confirmDeleteBtn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the customer.');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = originalText;
                });
        });
    });
</script>
